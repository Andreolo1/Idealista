---
title: "AFC pisos"
author: "Adriana Chust Vendrell"
date: "13/4/2022"
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
    toc_float:
      collapsed: no
      smooth_scroll: yes
---


Antes de proceder a realizar el análisis factorial de correspondencias, cargamos las librerías necesarias para trabajar con R

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(FactoMineR)
library(factoextra)
library(corrplot)
```

# ABRIR EL ARCHIVO

Primeramente abrimos el archivo, y echamos un primer vistazo a las variables mediante la función summary().

```{r abrir}
vendidos = read.csv('datos/pisosMDP.csv', sep = ';')
summary(vendidos)
```
Como vemos, tenemos varias variables binarias que están clasificadas como categóricas. A continuación, procedemos a tipar las variables.


# TIPO DE VARIABLES

Para ello se creará un data-frame auxiliar descVend, que contenga el tipo de cada variable. 

```{r tipo variables}
descVend = data.frame("variable" = colnames(vendidos),
                      "tipo" = c(rep("numerical", 2), rep("binary", 4), "numerical", rep("binary", 2), "numerical", "categorical", rep("binary", 7), "numerical", rep("binary", 1), rep("numerical",2)),stringsAsFactors = FALSE)

rownames(descVend) = descVend$variable

```


# CONVERTIMOS A FACTORES

Para aplicar AFC, nuestras variables han de ser cualitativas. Como ya hemos dicho, las variables binarias se caracterizarán como factores. La variable distrito se dejará como categórica. El resto (las cuantitativas) se dejan en numérico.

```{r factores}
vendidos[which(descVend$tipo == 'binary')] = lapply(vendidos[which(descVend$tipo == 'binary')], as.factor)

```


# AFC MÚLTIPLE

Realizamos AFC múltiple, pues tenemos varias variables cualitativas correspondientes a más de 1000 observaciones.
La variable distrito la dejamos como auxiliar cualitativa.
Las variables baños, metros cuadrados, habitaciones, precio_final, planta, variación precio y días en el mercado, como son cuantitativas las dejamos como auxiliares también.


```{r afc}
res.mca <- MCA(vendidos[,1:22], graph = FALSE, quanti.sup = c(1,2,7,10,19,21,22), quali.sup = 11) 

eig.val <- get_eigenvalue(res.mca)
Vmedia = 100 * (1/nrow(eig.val))

fviz_eig(res.mca, addlabels = TRUE) + geom_hline(yintercept=Vmedia, linetype=2, color="red") 

kable(head(eig.val))

res.mca <- MCA(vendidos[,1:22], graph = FALSE, quanti.sup = c(1,2,7,10,19,21,22), quali.sup = 11, ncp = 5)
```


Seleccionaremos 5 dimensiones, que explican el `r round(eig.val[5,3],1)`% de la inercia total.

## Interpretación del modelo

A continuación se muestran algunos gráficos ejemplo para poder interpretar el modelo.

### Individuos

```{r mca3, fig.width=5, fig.height=5}

# Dimensiones 1 y 2

fviz_mca_ind(res.mca, axes = c(1,2),
             label = "none",
              habillage = 'distrito')

# Dimensiones 3 y 4

fviz_mca_ind(res.mca, axes = c(3,4),
             label = "none",
              habillage = 'distrito')

# Dimensiones 4 y 5

fviz_mca_ind(res.mca, axes = c(4,5),
             label = "none",
              habillage = 'distrito')

```

Vamos a colorear por otras variables (que creemos que pueden tener relación)

```{r otras variables}
fviz_ellipses(res.mca, c("jardin", "piscina"), geom = "point")
```

```{r otras variables2}
fviz_ellipses(res.mca, c("terraza", "ascensor"), geom = "point")
```

```{r otras variables3}
fviz_ellipses(res.mca, c("a_reformar"), geom = "point")
```

```{r otras variables4}
fviz_ellipses(res.mca, c("trastero", "garaje.incluido"), geom = "point")
```

```{r otras variables5}
fviz_ellipses(res.mca, c("calefaccion", "aire.acondicionado"), geom = "point")
```


### Variables


```{r mca4, fig.width=5, fig.height=5}

# Correlación entre variables y dos primeras dimensiones
fviz_mca_var(res.mca, choice = "mca.cor", repel = TRUE, 
ggtheme = theme_minimal())

# Correlación entre variables y dimensiones 3 y 4
fviz_mca_var(res.mca, choice = "mca.cor", repel = TRUE, 
ggtheme = theme_minimal(), axes = c(3,4))

# Correlación entre variables y dimensiones 4 y 5
fviz_mca_var(res.mca, choice = "mca.cor", repel = TRUE, 
ggtheme = theme_minimal(), axes = c(4,5))

# Correlación entre variables y dimensiones
corrplot(res.mca$var$cos2, is.corr=FALSE, tl.col = 1, win.asp = 0.5, cl.ratio = 0.3, cl.cex = 0.8)

fviz_cos2(res.mca, choice = "var", axes = 1:5)

fviz_mca_var(res.mca, col.var="steelblue", shape.var = 15)

```


Representamos ahora las contribuciones de las variables a cada dimensión

```{r variables2}

# Contributions de las variables a la dimension 1
fviz_contrib(res.mca, choice = "var", axes = 1, top = 15)
# Contributions de las variables a la dimension 2
fviz_contrib(res.mca, choice = "var", axes = 2, top = 15)
# Contributions de las variables a la dimension 3
fviz_contrib(res.mca, choice = "var", axes = 3, top = 15)
# Contributions de las variables a la dimension 4
fviz_contrib(res.mca, choice = "var", axes = 4, top = 15)
# Contributions de las variables a la dimension 5
fviz_contrib(res.mca, choice = "var", axes = 5, top = 15)

# Top 10 variables con el cos2 mas alto
fviz_mca_var(res.mca, select.var= list(cos2 = 10))

```


### Biplot

Veamos ahora la relación entre variables e individuos

```{r mca5, fig.width=5, fig.height=5}

# Biplots simétricos
fviz_mca_biplot(res.mca, geom.ind = "point",
repel = TRUE, ggtheme = theme_minimal(), habillage = 'distrito', select.var = list(contrib = 10), col.var = 'black')

# top 10 individuos y variables con contribuciones mas altas
fviz_mca_biplot(res.mca, select.ind = list(contrib = 50), 
select.var = list(contrib = 10), repel = TRUE, ggtheme = theme_minimal(), habillage = 'distrito', label = 'var', col.var = 'black')
```
