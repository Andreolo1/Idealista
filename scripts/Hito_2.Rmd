---
title: "Hito 2"
author: "Eva Cantín Larumbe"
date: "23/4/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(kableExtra)
```

# 1. Lectura datos
```{r datos, echo=TRUE}
vendidas = read.csv("../datos/viviendas_vendidas.csv", sep=';', row.names = 1, as.is = TRUE, encoding = 'UTF-8')
```

# 2. Análisis exploratorio de los datos y limpieza
## 2.1 Eliminación de variables
``` {r eliminar variables, echo=TRUE}
vendidas = vendidas[,setdiff(colnames(vendidas), c("ad_condition_isGoodCondition", "ad_operation",  "address_location", "date_insert", "date_update", "latitude", "longitude", "price", "url", "date_last", "features" ,"day_insert", "day_last", "vendido", "ad_characteristics_hasParking"))]

colnames(vendidas)= c('baños', 'm2', 'jardin', 'ascensor', 'piscina', 'terraza', 'habitaciones', 'a_reformar', 'tipo_vendedor', 'tipo_vivienda', 'precio_final', 'distrito', 'barrio', "armarios.empotrados", "acceso.adaptado", "aire.acondicionado", "balcon", "trastero", "garaje.incluido", "calefaccion", "planta", "vistas", "variacion_precio", "dias_venta")
```

## 2.2 Exploración de Variables y Observaciones

Vamos a ver cuántos inmuebles hay de cada tipo. 1:pisos, 2:casas y 10:obras nuevas
```{r tipo inmuebles}
table(vendidas$tipo_vivienda)
```
> 2325/2478*100 --> 93.82567%
> 74/2478*100 --> 2.986279%
> 79/2478*100 --> 3.188055%

Vamos a ver en qué distritos se encuentran las casas y las obras nuevas.
```{r distritos tipo inmuebles}
table(vendidas$distrito[vendidas$tipo_vivienda==2])

table(vendidas$distrito[vendidas$tipo_vivienda==10])
```
Como 28 de 74 casas (37,83%), se encuentran en Poblats Marítims (son casas modestas, de pescadores), hemos decidido excluir las casas del análisis. 

En el casa de las obras nuevas, al ser un 3,188% del total de viviendas y la distribución por distritos es más parecida, también vamos a eliminarlas del estudio.
```{r eliminar tipo inmuebles}
casas = which(vendidas$tipo_vivienda==2)
nuevas = which(vendidas$tipo_vivienda==10)
vendidas = vendidas[-casas, ]
vendidas = vendidas[-nuevas, ]
```

Como ahora la variable tipo_vivienda es constante, (tipo_vivienda=1), la eliminamos de la BD.
```{r eliminar tipo_vivienda}
borrar = c("tipo_vivienda")
vendidas = vendidas[ , !(names(vendidas) %in% borrar)]
```

### 2.2.1 BAÑOS, HABITACIONES Y M2 
A continuación, vamos a hacer una exploración de las variables "Baños"; "Habitaciones" y "M2". Si una casa no tiene ni baños, ni habitaciones ni M2, la eliminaremos de la BD, ya que consideramos que estas tres varaibles son **fundamentales** para el análisis inmobiliario.

Por otro lado, vamos a ver si hay valores anómalos en dichas variables. 
```{r baños_hab_m2, echo=TRUE}
#ver cuántos baños tenemos a 0
hist(vendidas$baños, main = "Histograma de frecuencias por BAÑO", 
     ylab = "Frecuencia", breaks=100)

#Número máximo de baños --> 41
max(vendidas$baños, na.rm=TRUE)

#Ver cuántos pisos no tienen baños --> 76 pisos
sum(vendidas$baños==0, na.rm=TRUE)
nulos = which(vendidas$baños==0)
vendidas$baños[vendidas$baños== 41] = 1

vendidas = vendidas[-nulos, ]

hist(vendidas$baños, main = "Histograma de frecuencias por BAÑO", 
     ylab = "Frecuencia", breaks=100)

#HABITACIONES
hist(vendidas$habitaciones) 
sum(vendidas$habitaciones == 0, na.rm=TRUE) 
quitar = which(vendidas$habitaciones == 0)
vendidas = vendidas[-quitar, ]
prec_quitar = which(vendidas$precio == 0)
```

Hemos observado que hay un piso con 41 baños y 85m2. Como consideramos esto un **error**, y lo más probable es que tenga 1 baño, lo hemos corregido. 

Por otra parte, hemos visto que hay 76 pisos sin baño, pero también hemos comprobado que estos pisos tampoco tienen el número de habitaciones y los m2. Por ello, se eliminan estos 76 individuos.

En cuanto al número de habitaciones, sigue habiendo 30 pisos sin él. Se han eliminado estos pisos también.

Por último, hemos estudiado si había algún piso sin el precio de venta. Como hemos visto que esta condición NO se cumple, no hemos eliminado ninguna observación.


### 2.2.2 DIAS_VENTA
Respecto a la variable "Dias_venta", se ha llevado a cabo un pequeño proceso de transformación. Esta variable inicialmente era una cadena de caracteres (String) con el siguiente formato: 'num + days'. 

El proceso de transformación ha consistido en eliminar la palabra 'days' y convertir el número a un entero (int).

Finalmente, si algún piso tenía un número negativo de días de venta, lo hemos corregido a 0, puesto que lo hemos considerado un error y creemos que es una solución coherente.
```{r dias_venta, echo=TRUE}
vendidas$dias_venta = gsub(" days", "", vendidas$dias_venta)
vendidas = transform(vendidas, dias_venta = as.numeric(dias_venta))

# Ponemos a 0 los días_venta a aquellos pisos que tengan días negativos
vendidas$dias_venta[vendidas$dias_venta < 0] = 0
```

## 2.3 Transformación y recodificación de variables

si queremos incluir una variable categórica en un modelo que solo acepta variables numéricas, podemos recodificar la variable categórica a variables numéricas 0-1 y así ya la podríamos incluir en dicho modelo. 

En nuestro caso, la variable vistas es una variable binaria que tiene 2 categorías: "exterior" e "interior". Con el fin de convertirla a binaria numérica, vamos a codificar **"exterior" a 1** e **"interior" a 0**.

```{r nueva, echo = TRUE}
# a binarias: vistas (interior = 0, exterior = 1)
vendidas$vistas[vendidas$vistas == 'exterior'] = 1
vendidas$vistas[vendidas$vistas == 'interior'] = 0
vendidas$vistas[vendidas$vistas == ''] = NA
vendidas$vistas[vendidas$vistas == 'TRUE'] = NA
vendidas$vistas[vendidas$vistas == 'FALSE'] = NA
```

## 2.4 Valores faltantes. Imputación.
Generaremos en primer lugar una tabla resumen con el número y porcentaje de valores faltantes en cada variable en la base de datos.

```{r tipos variables, echo = TRUE}
descVend = data.frame("variable" = colnames(vendidas),
                      "tipo" = c(rep("numerical", 2), rep("binary", 4), "numerical", rep("binary", 2), "numerical", rep("categorical", 2), rep("binary", 7), "numerical", rep("binary", 1), rep("numerical",2)),stringsAsFactors = FALSE)
rownames(descVend) = descVend$variable
```

```{r missing, echo = TRUE}
library(kableExtra)
numNA = apply(vendidas, 2, function(x) sum(is.na(x)))
percNA = round(100*apply(vendidas, 2, function(x) mean(is.na(x))), 2)
tablaNA = data.frame("tipo" = descVend[,-1], numNA, percNA)
kable(tablaNA, format="latex", booktabs = T) %>% kable_styling() 
```

En esta tabla, se puede observar cómo hay 2 variables con datos faltantes: "planta" y "vistas". El porcentaje de NAs respecto del total de datos es 6.98% y 18.37% respectivamente. Como ninguna de las dos supera el 20% de datos faltantes, no tendría sentido eliminarlas, ni eliminar los registros.

La solución más viable y por la que nos hemos decantado es imputar estos datos con la librería mice() de R. Imputarlos con la media no nos parece un buen método, ya que sesgaría los resultados.

```{r imputar vistas, echo=TRUE, warning=FALSE}
library(mice)

#convertimos las variables binarias a factores
vendidas[which(descVend$tipo == 'binary')] = lapply(vendidas[which(descVend$tipo == 'binary')], as.factor)
vend = vendidas
vendImp = mice(vend, seed = 123, m = 5, print = FALSE, method = NULL)

head(vendImp$imp$vistas)
vendImp = complete(vendImp) #Complete a data frame with missing combinations of data
```
Tras haber imputado los datos faltantes con la librería mice, vamos a ver cómo han cambiado las variables que tenían datos faltantes ("planta" y "vistas"):

```{r cambios imputacion, echo=TRUE}
summary(vend$vistas)
summary(vendImp$vistas)

summary(vend$planta)
summary(vendImp$planta)
```

Volvemos a generar la tabla resumen con el número y porcentaje de valores faltantes en cada variable en la base de datos. Como se puede ver, ya no tenemos ningún dato faltante en nuestra BD:

```{r missing tras imputar, echo=TRUE}
numNA = apply(vendImp, 2, function(x) sum(is.na(x)))
percNA = round(100*apply(vendImp, 2, function(x) mean(is.na(x))), 2)
tablaNA = data.frame("tipo" = descVend[,-1], numNA, percNA)

kable(tablaNA, format="latex", booktabs = T) %>% kable_styling() 
```


# 3. Exploración de los distritos de los pisos

En primer lugar, realizamos gráficos que puedan mostrarnos el precio según los distritos:

```{r grafico precio_distrito, echo=TRUE}
vendidas_distritos = vendImp
ggplot(vendidas_distritos, 
       aes(precio_final, 
           fill = distrito)) +
  geom_density(alpha = 0.4) +
  labs(title = "Distribución de los precios según distrito")
```
Como la distribución es extremadamente asimétrica positiva, aplicamos logaritmo al eje de las X (precio_final)

```{r log precio_final, echo=TRUE}
plotdata_logprice <- vendidas_distritos %>%
  group_by(distrito) %>%
  summarise(log_price = log(precio_final))
```

```{r grafico distrito_precios log, echo=TRUE}
ggplot(plotdata_logprice, 
       aes(log_price, 
           fill = distrito)) +
  geom_density(alpha = 0.4) +
  labs(title = "Distribución de los precios logarítmicos según distrito")
```

Ahora realizamos boxplot con los precios de los pisos según distritos:
```{r boxplot precios_distrito, echo=TRUE}
ggplot(vendidas_distritos, 
       aes(x = distrito, 
           y = precio_final)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_boxplot() +
  labs(title = "Distribución de los precios según distrito")
```

# 4. Exploración del precio_final de los pisos
```{r boxplot precio_final}
boxplot(vendidas_distritos$precio_final, main = "Sin reemplazo de outliers con R")
summary(vendidas_distritos$precio_final)

#RANGO INTERCUARTÍLICO
IQR = 295000 - 120000

#UMBRAL SUPERIOR
sup = 120000 + 1.5 * IQR

#UMBRAL INFERIOR
inf = 120000 - 1.5 *IQR

hist(vendImp$precio_final)
```
## 4.1 Transformaciones: logaritmo y raíz cúbica
```{r transf precio_final, echo=TRUE}
log_precio=log(vendImp$precio_final)
hist (vendImp$precio_final, col = 'blue', main = 'Original')
hist(log_precio, col = 'coral2', main = 'Logaritmo precio')

cube_precio=vendImp$precio_final ^ (1/3)
hist (vendImp$precio_final, col = 'blue', main = 'Original')
hist(cube_precio, col = 'coral2', main = 'Raíz Cúbica precio')
```


## 4.2 Diferencias entre tipo_vendedor=1 (particular) y tipo_vendedor=2 (inmobiliaria)

```{r dif inmobiliaria y part, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=tipo_vendedor)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  
```
Como podemos observar en este gráfico de barras agrupadas, hay 3 distritos en los que hay una gran diferencia entre los pisos vendidos por inmobiliarias y particulares. Estos distritos son Ciutat Vella, El pla del Real y L'Eixample. Vamos a ver qué ocurre con estos distritos.

```{r exploracion, echo=TRUE }
ciutat_vella= vendImp[vendImp$distrito == "ciutat vella",]
pla_real=vendImp[vendImp$distrito=="el pla del real",]
eixample=vendImp[vendImp$distrito=="l'eixample",]

dif = rbind(ciutat_vella, pla_real, eixample)
```

```{r exploracion2, echo=TRUE}
ggplot(dif, aes(x=barrio, y=precio_final, fill=tipo_vendedor)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  

kable(t(summary(ciutat_vella[ciutat_vella$tipo_vendedor==1,]))) %>% kable_styling(font_size=8)  #particular
kable(t(summary(ciutat_vella[ciutat_vella$tipo_vendedor==2,]))) %>% kable_styling(font_size=8) #inmobiliaria

kable(t(summary(pla_real[pla_real$tipo_vendedor==1,]))) %>% kable_styling(font_size=8)  #particular
kable(t(summary(pla_real[pla_real$tipo_vendedor==2,]))) %>% kable_styling(font_size=8) #inmobiliaria

kable(t(summary(eixample[eixample$tipo_vendedor==1,]))) %>% kable_styling(font_size=8)  #particular
kable(t(summary(eixample[eixample$tipo_vendedor==2,]))) %>% kable_styling(font_size=8) #inmobiliaria
```


```{r summarise tipo_vendedor, echo=TRUE}
df2 = vendImp %>% group_by(tipo_vendedor) %>% summarise(N= n(), media_m2 = mean(m2), media_baños = mean(baños), media_habitaciones = mean(habitaciones), media_precio = mean(precio_final), media_dias_venta = mean(dias_venta), SD_precio = sd(precio_final), min_precio = min(precio_final), max_precio=max(precio_final), porc_jardin = sum(jardin==1)/N*100, porc_ascensor=sum(ascensor==1)/N*100, porc_terraza= sum(terraza==1)/N*100, porc_reformar=sum(a_reformar==1)/N*100, porc_aire = sum(aire.acondicionado==1)/N*100, porc_trastero=sum(trastero==1)/N*100, porc_garaje=sum(garaje.incluido==1)/N*100, porc_calefaccion=sum(calefaccion==1)/N*100, media_planta=mean(planta), porc_exterior=sum(vistas==1)/N*100)

df3 = as.data.frame(t(df2))
colnames(df3) = c("Particular", "Inmobiliaria")
kable(df3, digits=2)
#Pisos vendidos INMOBILIAIRA
#> 2100/6344 -->0.3310214

#Pisos vendidos PARTICULAR
#> 121/452 --> 0.2676991

kable(descVend, "latex", booktabs = T) %>% kable_styling() 
```

## 4.3 Relación entre el precio final y los complementos

### 4.3.1 Precio y num planta-ascensor
```{r precio-num planta, echo=TRUE}
planta_cat=cut(vendImp$planta, breaks = c(0, 2, 4,100), include.lowest = TRUE)
levels(planta_cat) <- c("Baja", "Media", "Alta")
vendImp = cbind(vendImp, planta_cat)
descVend = data.frame("variable" = colnames(vendImp),
                      "tipo" = c(rep("numerical", 2), rep("binary", 4), "numerical", rep("binary", 2), "numerical", rep("categorical", 2), rep("binary", 7), "numerical", rep("binary", 1), rep("numerical",2), "binary"),stringsAsFactors = FALSE)
rownames(descVend) = descVend$variable


te_asc=vendImp$planta_cat[which(vendImp$ascensor==1)]
nte_asc=vendImp$planta_cat[which(vendImp$ascensor==0)]

#par (mfrow=c (1,2))
plot(te_asc,vendImp$precio_final[which(vendImp$ascensor==1)],pch = 19, ylim = c (0,4000000), main = 'Precio de pisos con ascensor', ylab='Precio final',xlab='Planta')
plot(nte_asc,vendImp$precio_final[which(vendImp$ascensor==0)],pch = 19, ylim = c (0,4000000), main = 'Precio de pisos sin ascensor',ylab='Precio final',xlab='Planta')
```

### 4.3.2 Relación entre el precio y la planta (discretizada)
```{r precio-planta disc, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=planta_cat)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.3 Relación entre el precio y ascensor
```{r precio-ascensor, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=ascensor)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.4 Relación entre el precio y jardín
```{r precio-jardin, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=jardin)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.5 Relación entre el precio y piscina
```{r precio-piscina, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=piscina)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.6 Relación entre el precio y terraza
```{r precio-terraza, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=terraza)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.7 Relación entre el precio y condición del piso (a_reformar)
```{r precio-reforma, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=a_reformar)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.8 Relación entre el precio y aire acondicionado
```{r precio-aire acond, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=aire.acondicionado)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.9 Relación entre el precio y armarios empotrados
```{r precio-armarios emp, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=armarios.empotrados)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.10 Relación entre el precio y acceso adaptado
```{r precio-acceso adap, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=acceso.adaptado)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.11 Relación entre el precio y balcón
```{r precio-balcon, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=balcon)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.12 Relación entre el precio y trastero
```{r precio-trastero, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=trastero)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.13 Relación entre el precio y garaje
```{r precio-garaje, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=garaje.incluido)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### 4.3.13 Relación entre el precio y calefaccion
```{r precio-calefaccion, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=precio_final, fill=calefaccion)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## 4.4 Relación entre precio_final y m2
```{r distritos a factor}
distritos = factor(vendidas_distritos$distrito)
plot(x = vendidas_distritos$precio_final, y = vendidas_distritos$m2, col=distritos)
```

```{r smooth precio_m2, echo=TRUE}
smoothScatter(vendidas_distritos$m2, vendidas_distritos$precio_final)

smoothScatter(vendidas_distritos$m2, vendidas_distritos$precio_final,
              colramp = colorRampPalette(c("#000099", "#00FEFF", "#45FE4F",                                      "#FCFF00", "#FF9400", "#FF3100")))
```
```{r, echo=TRUE}
library(MASS)
kern <- kde2d(vendidas_distritos$precio_final, vendidas_distritos$m2)
```

Dividimos el dataset en 2: los pisos que tienen un precio menor a 450000€ y superior a 450000€

### 4.4.1 Pisos de -450000€
```{r precio_m2 baratos}
plot(x = vendidas_distritos$m2[vendidas_distritos$precio_final<=450000], y = vendidas_distritos$precio_final[vendidas_distritos$precio_final<=450000], col=distritos)

ajuste_linear=lm(vendidas_distritos$precio_final ~ vendidas_distritos$m2)
ajuste_linear
abline(ajuste_linear, col = "white", lwd = 1)

#Correlación entre el precio y los m2 de los pisos de menos de 450000€
cor(vendidas_distritos$precio_final[vendidas_distritos$precio_final<=450000], vendidas_distritos$m2[vendidas_distritos$precio_final<=450000])
```
### 4.4.2 Pisos de +450000€
```{r precio_m2 caros, echo=TRUE}
plot(x = vendidas_distritos$m2[vendidas_distritos$precio_final>450000], y = vendidas_distritos$precio_final[vendidas_distritos$precio_final>450000], col=distritos)

ajuste_linear=lm(vendidas_distritos$precio_final ~ vendidas_distritos$m2)
ajuste_linear
abline(ajuste_linear, col = "black", lwd = 1)

#Correlación entre el precio y los m2 de los pisos de más de 450000€
cor(vendidas_distritos$precio_final[vendidas_distritos$precio_final>450000], vendidas_distritos$m2[vendidas_distritos$precio_final>450000])
```

Como hemos visto en el coeficiente de correlación, la correlación entre los m2 y el precio, en los pisos de menos de 450000€ es más fuerte que en los pisos que superan esta cifra (0.6629108, frente a 0.5122289). Esto nos quiere decir que, pasado un precio, los m2 ya no influyen tanto como lo hacen en pisos pequeños.


## 4.5 Precio por m2
Vamos a crear una variable llamada m2, que nos ayudará mucho más a entender la BD, de la que disponemos.
```{r nueva variable precio_m2, echo=TRUE}
preciom2 = vendImp$precio_final/vendImp$m2
vendImp = cbind(vendImp, preciom2)
descVend = data.frame("variable" = colnames(vendImp),
                      "tipo" = c(rep("numerical", 2), rep("binary", 4), "numerical", rep("binary", 2), "numerical", rep("categorical", 2), rep("binary", 7), "numerical", rep("binary", 1), rep("numerical",2), "binary", "numerical"),stringsAsFactors = FALSE)
rownames(descVend) = descVend$variable

kable(descVend, "latex", booktabs = T) %>% kable_styling()
```

### 4.5.1 Boxplot de preciom2 por distrito
```{r boxplot precio medio distrito}
ggplot(vendImp, 
       aes(x = distrito, 
           y = preciom2)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_boxplot() +
  labs(title = "Distribución del precio por m2 según los distritos")

summary(vendImp)
```

### 4.5.2 Precio por m2 y tipo vendedor (1=particular, 2=inmobiliaria)
```{r tipo vendedor preciom2, echo=TRUE}
ggplot(vendImp, aes(x=distrito, y=preciom2, fill=tipo_vendedor)) + geom_col(position = "dodge") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

```


# 5. Matriz de correlación entre variables numéricas
Para ver si nuestras variables numéricas tienen correlación, vamos a hacer una matriz de correlación. También, vamos calcular su P-valor para determinar si dicha correlación es significativa o no.

```{r cor variab numericas, echo=TRUE}
library(corrplot)
library (Hmisc)
vendCor = vendidas2[,c("baños", "m2", "habitaciones", "planta", "precio_final", "variacion_precio", "dias_venta", "preciom2")]
cor = cor(vendCor)
c = rcorr(as.matrix(vendCor),type="pearson")
c1 = c[['r']]
c2 = c[['P']] #p-value
kable(c1, format="latex", booktabs = T) %>% kable_styling(font_size = 8) 
kable(c2, format="latex", booktabs = T) %>% kable_styling(font_size = 8)
corrplot(cor, method = 'number', number.font = 4, tl.col = 'black', number.cex = 0.75)
```

```{r cor variab binarias, echo=TRUE}
library(corrplot)
library (Hmisc)
vendCor = vendImp[,c("jardin", "ascensor", "piscina", "terraza", "a_reformar", "armarios.empotrados", "acceso.adaptado", "aire.acondicionado", 'balcon', 'trastero', 'garaje.incluido', 'calefaccion')]
index = 1:ncol(vendCor)
vendCor[, index] = lapply(vendCor[, index], as.numeric)
cor = cor(vendCor)
c = rcorr(as.matrix(vendCor),type="pearson")
c1 = c[['r']]
c2 = c[['P']] #p-value
kable(c1, format="latex", booktabs = T) %>% kable_styling(font_size = 8) 
kable(c2, format="latex", booktabs = T) %>% kable_styling(font_size = 8)
corrplot(cor, method = 'number', number.font = 4, tl.col = 'black', number.cex = 0.75)
```


### 6. Comparar precio del m2 según idealista y según el catastro
```{r}
# obtener el precio m2 con los datos que tenemos
vendidas$precio_m2 = vendidas$precio_final/vendidas$m2
distritos = vendidas %>% group_by(distrito) %>% summarise(preciom2 = mean(precio_m2))

# datos del catastro
catastro = c(433.07, 396.92, 420.44, 463.39, 494.11, 526, 646.24, 503.39, 469.88, 572.55, 355.31, 370.52, 416.37, 325.44, 316.26, 290.76, 344.82, 390.62, 481.41)

# unimos en un df
distritos = cbind(distritos, catastro)
colnames(distritos)

# hacemos el gráfico de columnas agrupadas
library("billboarder")

billboarder() %>%
  bb_barchart(
    data = distritos[, c("distrito", "preciom2", "catastro")]
  ) %>%
  bb_data(
    names = list(preciom2 = "Idealista", catastro = "Catastro")
  ) %>% 
  bb_colors_manual(
    "ECO" = "#41AB5D", "FPM" = "#4292C6"
  ) %>%
  bb_y_grid(show = TRUE) %>%
  bb_y_axis(tick = list(format = suffix("Euros")),
            label = list(text = "Valor del m2", position = "outer-top")) %>% 
  bb_legend(position = "inset", inset = list(anchor = "top-right")) %>% 
  bb_labs(title = "Comparación del valor del m2 en idealista y en el catastro") 

```

